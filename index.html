<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem eTempah Makmal Komputer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray pastel */
        }
        /* Custom styles for disabled elements */
        button:disabled, input:disabled, select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #e2e8f0;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <img src="https://i.postimg.cc/503jYPY1/LOGO-SEKOLAH-SKTK-removebg-preview.png" alt="Logo Sekolah" class="mx-auto h-24 w-auto mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-700">Sistem eTempah Makmal Komputer</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Borang Tempahan</h2>
                <form id="bookingForm" class="space-y-4">
                    
                    <div>
                        <label for="teacher" class="block text-sm font-medium text-slate-700 mb-1">Nama Guru</label>
                        <select id="teacher" name="teacher" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                            <option value="" disabled selected>-- Sila Pilih Guru --</option>
                        </select>
                    </div>

                    <div>
                        <label for="class" class="block text-sm font-medium text-slate-700 mb-1">Nama Kelas</label>
                        <select id="class" name="class" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                             <option value="" disabled selected>-- Sila Pilih Kelas --</option>
                        </select>
                    </div>

                    <div>
                        <label for="subject" class="block text-sm font-medium text-slate-700 mb-1">Subjek</label>
                        <select id="subject" name="subject" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                            <option value="" disabled selected>-- Sila Pilih Subjek --</option>
                        </select>
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-slate-700 mb-1">Tarikh</label>
                        <input type="date" id="date" name="date" class="mt-1 block w-full pl-3 pr-4 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                    </div>

                    <div>
                        <label for="timeSlot" class="block text-sm font-medium text-slate-700 mb-1">Slot Masa</label>
                        <select id="timeSlot" name="timeSlot" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                             <option value="" disabled selected>-- Sila Pilih Masa --</option>
                        </select>
                    </div>

                    <div id="messageBox" class="p-3 rounded-md text-sm transition-opacity duration-300"></div>

                    <button type="submit" id="submitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300 flex items-center justify-center">
                        <span id="submitButtonText">Tempah Slot</span>
                    </button>

                </form>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center border-b pb-4 mb-2">
                        <h2 class="text-2xl font-semibold">Senarai Tempahan Makmal</h2>
                        <button id="refreshBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-md transition-colors text-sm">
                            Refresh
                        </button>
                    </div>
                    
                    <div class="flex justify-between items-center my-4 p-2 bg-slate-100 rounded-lg">
                        <button id="prevWeekBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            &lt; Lepas
                        </button>
                        <h3 id="weekRangeDisplay" class="text-lg font-semibold text-center text-slate-700"></h3>
                        <button id="nextWeekBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            Depan &gt;
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tarikh</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Masa</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Guru</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kelas</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Subjek</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody" class="bg-white divide-y divide-slate-200">
                                 <tr>
                                    <td colspan="5" class="px-6 py-10 text-center text-slate-500">Memuatkan data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="analyticsSection" class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Analisis Penggunaan Mingguan</h2>
                    <div id="chartsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-center mb-2">Mengikut Guru</h3>
                            <div class="chart-container">
                                <canvas id="teacherChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-center mb-2">Mengikut Subjek</h3>
                             <div class="chart-container">
                                <canvas id="subjectChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-center mb-2">Mengikut Kelas</h3>
                             <div class="chart-container">
                                <canvas id="classChart"></canvas>
                            </div>
                        </div>
                    </div>
                     <p id="noAnalyticsData" class="text-center text-slate-500 py-8 hidden">Tiada data untuk dipaparkan dalam graf.</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxWneuWlrUkDGJBZXvSkjPfIuuBte6wV3XZDA1FOiyL1b1EbvqILENrOs_87NiebqK_/exec";

            // --- Data for dropdowns ---
            const teachers = ["AMIRUL FAHMI BIN YUSUP", "AQEELA BINTI ALIAH", "ELIANE BINTI AZMI", "EMYLIA FARHAN BINTI MOHAMAD YUSOF", "FALIZAH BINTI MOHAMAD ARSHAD", "FARIDAH BINTI HAMZAH", "HAYATI BINTI RAMLI", "IDAHTUL ARRSHYUL NA'AIEM BINTI A. RAHMAN", "KHAIRUL HAFFIZ BIN AZIZAN", "MAHANUM BINTI MOKHTAR", "MAZIAH BINTI MUHAMMAD", "MAZNAH BINTI KAMARUDDIN", "MOHAMED ZAMRI BIN SALLEH", "MOHD MUZAMER BIN ZAINODDIN", "MOHD ZAHARI BIN ISHAK", "NADHATUL AKMA BINTI ZAINAL", "NAIMAH BINTI MOHD NOH", "NOOR HAFIZAH BINTI OTHMAN", "NOORSUZANA BINTI NORDIN", "NOR AZIDAH BINTI MOHAMAD", "NOR EAZAH BINTI ITHNIN", "NOR MAIZANNI BINTI KHALIDI", "NORYANA BINTI ABDUL RAZAK", "NURUL ASHIKIN BINTI AMIRUDDIN", "NURUL SYAZWANI BINTI MD BASRI", "ROHAIDA BINTI MD ALI", "ROHAYA BINTI IBERAHIM", "ROSLAN BIN IBRAHIM", "ROZAINI BINTI TAJON AROS", "ROZIANA BINTI ARRIFFIN", "SITI MARHAMAH BINTI MUHAMAD", "SITI SANISAH BINTI HUSAIN", "SITI ZAHARAH BINTI ISHAK", "ZAITOON BINTI AHMAD", "ZAURAIDAH BINTI KAMARUDIN"];
            const classes = ["1 Al Ikhlas", "1 Al Falaq", "1 An Nas", "2 Al Ikhlas", "2 Al Falaq", "3 Al Ikhlas", "3 Al Falaq", "3 An Nas", "4 Al Ikhlas", "4 Al Falaq", "5 Al Ikhlas", "5 Al Falaq", "5 An Nas", "6 Al Ikhlas", "6 Al Falaq"];
            const subjects = ["BM", "BI", "MT", "SN", "PJ", "PK", "RBT", "SJ", "MZ", "PS", "PI", "ULM", "JW", "TS", "BA"];
            const timeSlots = ["07:40 AM", "08:10 AM", "08:40 AM", "09:10 AM", "09:40 AM", "10:10 AM", "10:30 AM", "11:00 AM", "11:30 AM", "12:00 PM", "12:30 PM", "01:00 PM"];

            // --- Get elements ---
            const bookingForm = document.getElementById('bookingForm');
            const formElements = [ document.getElementById('teacher'), document.getElementById('class'), document.getElementById('subject'), document.getElementById('date'), document.getElementById('timeSlot'), document.getElementById('submitButton') ];
            const [teacherSelect, classSelect, subjectSelect, dateInput, timeSlotSelect, submitButton] = formElements;
            const bookingTableBody = document.getElementById('bookingTableBody');
            const messageBox = document.getElementById('messageBox');
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const weekRangeDisplay = document.getElementById('weekRangeDisplay');
            const submitButtonText = document.getElementById('submitButtonText');
            const refreshBtn = document.getElementById('refreshBtn');
            const chartsContainer = document.getElementById('chartsContainer');
            const noAnalyticsData = document.getElementById('noAnalyticsData');


            // --- State Management ---
            let allBookings = [];
            let currentDate = new Date();
            let teacherChart, subjectChart, classChart;

            // --- Helper Functions ---
            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];

            const setLoadingState = (isLoading, element, textElement = null, originalText = '') => {
                if (isLoading) {
                    element.disabled = true;
                    if (textElement) textElement.textContent = '';
                    const loader = document.createElement('span');
                    loader.className = 'loader';
                    element.prepend(loader);
                } else {
                    element.disabled = false;
                    const loader = element.querySelector('.loader');
                    if (loader) loader.remove();
                    if (textElement) textElement.textContent = originalText;
                }
            };
            
            const getWeekRange = (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diffToMonday = d.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(d.setDate(diffToMonday));
                monday.setHours(0, 0, 0, 0);
                const friday = new Date(new Date(monday).setDate(monday.getDate() + 4));
                friday.setHours(23, 59, 59, 999);
                return { start: monday, end: friday };
            };

            const formatDateDisplay = (date) => date.toLocaleString('ms-MY', { day: '2-digit', month: 'short' });

            const populateSelect = (selectElement, options) => {
                options.sort().forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
            };

            const showMessage = (message, type = 'info') => {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
                
                let bgColor, textColor;
                switch(type) {
                    case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-800'; break;
                    case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-800'; break;
                    default: bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; break;
                }
                
                messageBox.classList.add(bgColor, textColor);
                if (type !== 'info') {
                     setTimeout(() => {
                         if (messageBox.textContent === message) {
                             messageBox.classList.add('hidden');
                         }
                     }, 5000);
                }
            };
            
             const convertTo24Hour = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(' ')) return '00:00'; 
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');
                if (hours === '12') hours = '00';
                if (modifier.toUpperCase() === 'PM') hours = parseInt(hours, 10) + 12;
                if (modifier.toUpperCase() === 'PM' && time.split(':')[0] === '12') hours = 12;
                return `${String(hours).padStart(2, '0')}:${minutes}`;
            };

            const chartColors = [ '#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#eab308', '#ec4899', '#14b8a6', '#a855f7', '#22c55e', '#f43f5e', '#0ea5e9', '#d946ef', '#f59e0b', '#6b7280', '#4338ca' ];
            const generateChartData = (bookings, property) => {
                const counts = bookings.reduce((acc, booking) => {
                    const key = booking[property];
                    acc[key] = (acc[key] || 0) + 1;
                    return acc;
                }, {});
                const sortedData = Object.entries(counts).sort(([,a],[,b]) => b-a);
                return {
                    labels: sortedData.map(item => item[0]),
                    data: sortedData.map(item => item[1])
                };
            };

            const createChart = (ctx, labels, data, chartType) => {
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: ' Bilangan Tempahan',
                            data: data,
                            backgroundColor: chartColors,
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            };

             const updateChart = (chart, newData) => {
                chart.data.labels = newData.labels;
                chart.data.datasets[0].data = newData.data;
                chart.update();
            };

            
            // --- Core Functions ---
            const manageBookingAccess = () => {
                const today = new Date();
                const dayOfWeek = today.getDay(); 
                const isBookingWindowOpen = [0, 5, 6].includes(dayOfWeek); 
                if (isBookingWindowOpen) {
                    formElements.forEach(el => el.disabled = false);
                    const daysUntilMonday = dayOfWeek === 5 ? 3 : (dayOfWeek === 6 ? 2 : 1);
                    const nextMonday = new Date(today);
                    nextMonday.setDate(today.getDate() + daysUntilMonday);
                    const nextFriday = new Date(nextMonday);
                    nextFriday.setDate(nextMonday.getDate() + 4);
                    dateInput.min = toYYYYMMDD(nextMonday);
                    dateInput.max = toYYYYMMDD(nextFriday);
                    showMessage(`Tempahan dibuka untuk minggu hadapan (${formatDateDisplay(nextMonday)} - ${formatDateDisplay(nextFriday)}).`, 'info');
                } else {
                    formElements.forEach(el => el.disabled = true);
                    showMessage('Tempahan untuk minggu hadapan hanya dibuka pada setiap hari Jumaat hingga Ahad.', 'info');
                }
            };

            const loadBookings = async () => {
                bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-500">Memuatkan data...</td></tr>';
                try {
                    const response = await fetch(SCRIPT_URL);
                    const result = await response.json();
                    if (result.success) {
                        allBookings = result.data;
                        renderBookings();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error("Error loading bookings:", error);
                    bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuatkan data. Sila periksa sambungan internet anda.</td></tr>';
                }
            };
            
            const renderBookings = () => {
                const week = getWeekRange(currentDate);
                weekRangeDisplay.textContent = `${formatDateDisplay(week.start)} - ${formatDateDisplay(week.end)}`;
                const weekBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.date);
                    return bookingDate >= week.start && bookingDate <= week.end;
                });

                bookingTableBody.innerHTML = '';
                if (weekBookings.length === 0) {
                    bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-500">Tiada tempahan untuk minggu ini.</td></tr>';
                } else {
                     weekBookings.sort((a, b) => {
                        const dateA = new Date(a.date).getTime();
                        const dateB = new Date(b.date).getTime();
                        if (dateA !== dateB) return dateA - dateB;
                        const timeA = convertTo24Hour(a.timeSlot);
                        const timeB = convertTo24Hour(b.timeSlot);
                        return timeA.localeCompare(timeB);
                    });

                    weekBookings.forEach(booking => {
                        const row = document.createElement('tr');
                        const bookingDateObj = new Date(booking.date);
                        let displayTime = booking.timeSlot;
                        if (typeof booking.timeSlot === 'string' && booking.timeSlot.includes('T')) {
                            try {
                                const timeAsDate = new Date(booking.timeSlot);
                                displayTime = timeAsDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                            } catch (e) { /* fallback */ }
                        }
                        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${bookingDateObj.toLocaleString('ms-MY', { weekday: 'long', day: '2-digit', month: '2-digit'})}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${displayTime}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.teacher}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.class}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.subject}</td>`;
                        bookingTableBody.appendChild(row);
                    });
                }
               
                // Update Analytics Charts
                if (weekBookings.length > 0) {
                    chartsContainer.classList.remove('hidden');
                    noAnalyticsData.classList.add('hidden');
                    updateChart(teacherChart, generateChartData(weekBookings, 'teacher'));
                    updateChart(subjectChart, generateChartData(weekBookings, 'subject'));
                    updateChart(classChart, generateChartData(weekBookings, 'class'));
                } else {
                    chartsContainer.classList.add('hidden');
                    noAnalyticsData.classList.remove('hidden');
                }
            };

            // --- Event Listeners ---
            refreshBtn.addEventListener('click', loadBookings);
            prevWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 7);
                renderBookings();
            });
            nextWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 7);
                renderBookings();
            });
            dateInput.addEventListener('input', (e) => {
                const selectedDate = new Date(e.target.value);
                const day = selectedDate.getUTCDay();
                if (day === 6 || day === 0) {
                    showMessage('Tempahan hanya dibenarkan pada hari Isnin hingga Jumaat.', 'error');
                    e.target.value = '';
                }
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newBookingData = { id: Date.now(), teacher: teacherSelect.value, class: classSelect.value, subject: subjectSelect.value, date: dateInput.value, timeSlot: timeSlotSelect.value };
                const isBooked = allBookings.some(booking => {
                    const existingDateStr = toYYYYMMDD(new Date(booking.date));
                    let existingTimeSlot = booking.timeSlot;
                    if (typeof booking.timeSlot === 'string' && booking.timeSlot.includes('T')) {
                        try {
                            const timeAsDate = new Date(booking.timeSlot);
                            existingTimeSlot = timeAsDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        } catch(e) { /* ignore */ }
                    }
                    return existingDateStr === newBookingData.date && existingTimeSlot === newBookingData.timeSlot;
                });

                if (isBooked) {
                    showMessage('Slot masa ini telah ditempah. Sila pilih slot lain.', 'error');
                    return;
                }
                setLoadingState(true, submitButton, submitButtonText, 'Tempah Slot');
                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addBooking', booking: newBookingData }) });
                    const result = await response.json();
                    if(result.success) {
                        showMessage('Tempahan berjaya!', 'success');
                        bookingForm.reset();
                        await loadBookings();
                    } else { throw new Error(result.message); }
                } catch(error) {
                     console.error("Error adding booking:", error);
                     showMessage('Gagal untuk membuat tempahan.', 'error');
                } finally {
                    setLoadingState(false, submitButton, submitButtonText, 'Tempah Slot');
                    manageBookingAccess();
                }
            });

            // --- Initial Setup ---
            populateSelect(teacherSelect, teachers);
            populateSelect(classSelect, classes);
            populateSelect(subjectSelect, subjects);
            populateSelect(timeSlotSelect, timeSlots);

            // Initialize Charts
            teacherChart = createChart(document.getElementById('teacherChart').getContext('2d'), [], []);
            subjectChart = createChart(document.getElementById('subjectChart').getContext('2d'), [], []);
            classChart = createChart(document.getElementById('classChart').getContext('2d'), [], []);
            
            manageBookingAccess(); 
            loadBookings(); 
        });
    </script>
</body>
</html>

