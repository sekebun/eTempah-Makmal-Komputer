<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem eTempah Makmal Komputer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        button:disabled, input:disabled, select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #e2e8f0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .timetable-cell {
            min-width: 80px;
            height: 40px;
            transition: background-color: 0.3s;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <img src="https://i.postimg.cc/503jYPY1/LOGO-SEKOLAH-SKTK-removebg-preview.png" alt="Logo Sekolah" class="mx-auto h-24 w-auto mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-700">Sistem eTempah Makmal Komputer</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Borang Tempahan</h2>
                <form id="bookingForm" class="space-y-4">
                    
                    <div>
                        <label for="teacher" class="block text-sm font-medium text-slate-700 mb-1">Nama Guru</label>
                        <select id="teacher" name="teacher" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                            <option value="" disabled selected>-- Sila Pilih Guru --</option>
                        </select>
                    </div>

                    <div>
                        <label for="class" class="block text-sm font-medium text-slate-700 mb-1">Nama Kelas</label>
                        <select id="class" name="class" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                             <option value="" disabled selected>-- Sila Pilih Kelas --</option>
                        </select>
                    </div>

                    <div>
                        <label for="subject" class="block text-sm font-medium text-slate-700 mb-1">Subjek</label>
                        <select id="subject" name="subject" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                            <option value="" disabled selected>-- Sila Pilih Subjek --</option>
                        </select>
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-slate-700 mb-1">Tarikh</label>
                        <input type="date" id="date" name="date" class="mt-1 block w-full pl-3 pr-4 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                    </div>

                    <div>
                        <label for="timeSlot" class="block text-sm font-medium text-slate-700 mb-1">Slot Masa</label>
                        <select id="timeSlot" name="timeSlot" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                             <option value="" disabled selected>-- Sila Pilih Masa --</option>
                        </select>
                    </div>

                    <div id="messageBox" class="p-3 rounded-md text-sm transition-opacity duration-300"></div>

                    <button type="submit" id="submitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300 flex items-center justify-center">
                        <span id="submitButtonText">Tempah Slot</span>
                    </button>

                </form>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center border-b pb-4 mb-2">
                        <h2 class="text-2xl font-semibold">Data Tempahan Mingguan</h2>
                        <button id="refreshBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-md transition-colors text-sm">
                            Refresh
                        </button>
                    </div>
                    
                    <div class="flex justify-between items-center my-4 p-2 bg-slate-100 rounded-lg">
                        <button id="prevWeekBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            &lt; Lepas
                        </button>
                        <h3 id="weekRangeDisplay" class="text-lg font-semibold text-center text-slate-700"></h3>
                        <button id="nextWeekBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            Depan &gt;
                        </button>
                    </div>
                    
                    <!-- Timetable View -->
                    <div id="timetable-view" class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold">Jadual Penggunaan Makmal</h3>
                        </div>
                        <div class="overflow-x-auto border border-slate-200 rounded-lg">
                            <table class="min-w-full text-center">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-2 text-xs font-medium text-slate-500 uppercase">Masa</th>
                                        <th class="p-2 text-xs font-medium text-slate-500 uppercase">Isnin</th>
                                        <th class="p-2 text-xs font-medium text-slate-500 uppercase">Selasa</th>
                                        <th class="p-2 text-xs font-medium text-slate-500 uppercase">Rabu</th>
                                        <th class="p-2 text-xs font-medium text-slate-500 uppercase">Khamis</th>
                                        <th class="p-2 text-xs font-medium text-slate-500 uppercase">Jumaat</th>
                                    </tr>
                                </thead>
                                <tbody id="timetableBody" class="divide-y divide-slate-200">
                                    <!-- Timetable rows will be generated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <h4 class="text-md font-semibold mb-2">Petunjuk Warna Guru</h4>
                            <div id="colorLegend" class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
                                <!-- Legend items will be generated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- List View -->
                    <div id="list-view" class="mt-8">
                        <h3 class="text-xl font-semibold mb-4">Senarai Tempahan Makmal</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tarikh</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Masa</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Guru</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kelas</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Subjek</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxWneuWlrUkDGJBZXvSkjPfIuuBte6wV3XZDA1FOiyL1b1EbvqILENrOs_87NiebqK_/exec";

            // --- Data for dropdowns ---
            const teachers = ["AMIRUL FAHMI BIN YUSUP", "AQEELA BINTI ALIAH", "ELIANE BINTI AZMI", "EMYLIA FARHAN BINTI MOHAMAD YUSOF", "FALIZAH BINTI MOHAMAD ARSHAD", "FARIDAH BINTI HAMZAH", "HAYATI BINTI RAMLI", "IDAHTUL ARRSHYUL NA'AIEM BINTI A. RAHMAN", "KHAIRUL HAFFIZ BIN AZIZAN", "MAHANUM BINTI MOKHTAR", "MAZIAH BINTI MUHAMMAD", "MAZNAH BINTI KAMARUDDIN", "MOHAMED ZAMRI BIN SALLEH", "MOHD MUZAMER BIN ZAINODDIN", "MOHD ZAHARI BIN ISHAK", "NADHATUL AKMA BINTI ZAINAL", "NAIMAH BINTI MOHD NOH", "NOOR HAFIZAH BINTI OTHMAN", "NOORSUZANA BINTI NORDIN", "NOR AZIDAH BINTI MOHAMAD", "NOR EAZAH BINTI ITHNIN", "NOR MAIZANNI BINTI KHALIDI", "NORYANA BINTI ABDUL RAZAK", "NURUL ASHIKIN BINTI AMIRUDDIN", "NURUL SYAZWANI BINTI MD BASRI", "ROHAIDA BINTI MD ALI", "ROHAYA BINTI IBERAHIM", "ROSLAN BIN IBRAHIM", "ROZAINI BINTI TAJON AROS", "ROZIANA BINTI ARRIFFIN", "SITI MARHAMAH BINTI MUHAMAD", "SITI SANISAH BINTI HUSAIN", "SITI ZAHARAH BINTI ISHAK", "ZAITOON BINTI AHMAD", "ZAURAIDAH BINTI KAMARUDIN"];
            const classes = ["1 Al Ikhlas", "1 Al Falaq", "1 An Nas", "2 Al Ikhlas", "2 Al Falaq", "3 Al Ikhlas", "3 Al Falaq", "3 An Nas", "4 Al Ikhlas", "4 Al Falaq", "5 Al Ikhlas", "5 Al Falaq", "5 An Nas", "6 Al Ikhlas", "6 Al Falaq"];
            const subjects = ["BM", "BI", "MT", "SN", "PJ", "PK", "RBT", "SJ", "MZ", "PS", "PI", "ULM", "JW", "TS", "BA"];
            const timeSlots = ["07:40 AM", "08:10 AM", "08:40 AM", "09:10 AM", "09:40 AM", "10:10 AM", "10:30 AM", "11:00 AM", "11:30 AM", "12:00 PM", "12:30 PM", "01:00 PM"];
            const daysOfWeek = ['ahad', 'isnin', 'selasa', 'rabu', 'khamis', 'jumaat', 'sabtu'];

            // --- Get elements ---
            const bookingForm = document.getElementById('bookingForm');
            const formElements = [ document.getElementById('teacher'), document.getElementById('class'), document.getElementById('subject'), document.getElementById('date'), document.getElementById('timeSlot'), document.getElementById('submitButton') ];
            const [teacherSelect, classSelect, subjectSelect, dateInput, timeSlotSelect, submitButton] = formElements;
            const bookingTableBody = document.getElementById('bookingTableBody');
            const timetableBody = document.getElementById('timetableBody');
            const colorLegend = document.getElementById('colorLegend');
            const messageBox = document.getElementById('messageBox');
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const weekRangeDisplay = document.getElementById('weekRangeDisplay');
            const submitButtonText = document.getElementById('submitButtonText');
            const refreshBtn = document.getElementById('refreshBtn');

            // --- State Management ---
            let allBookings = [];
            let currentDate = new Date();

            // --- Helper Functions ---
            const toYYYYMMDD = (d) => d.toISOString().split('T')[0];

            const setLoadingState = (isLoading, element, textElement = null, originalText = '') => {
                if (isLoading) {
                    element.disabled = true;
                    if (textElement) textElement.textContent = '';
                    const loader = document.createElement('span');
                    loader.className = 'loader';
                    element.prepend(loader);
                } else {
                    element.disabled = false;
                    const loader = element.querySelector('.loader');
                    if (loader) loader.remove();
                    if (textElement) textElement.textContent = originalText;
                }
            };
            
            const getWeekRange = (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diffToMonday = d.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(d.setDate(diffToMonday));
                monday.setHours(0, 0, 0, 0);
                const friday = new Date(new Date(monday).setDate(monday.getDate() + 4));
                friday.setHours(23, 59, 59, 999);
                return { start: monday, end: friday };
            };

            const formatDateDisplay = (date) => date.toLocaleString('ms-MY', { day: '2-digit', month: 'short' });

            const populateSelect = (selectElement, options, shouldSort = true) => {
                const optionsToRender = shouldSort ? [...options].sort() : options;
                optionsToRender.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
            };

            const showMessage = (message, type = 'info') => {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
                
                let bgColor, textColor;
                switch(type) {
                    case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-800'; break;
                    case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-800'; break;
                    default: bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; break;
                }
                
                messageBox.classList.add(bgColor, textColor);
                if (type !== 'info') {
                     setTimeout(() => {
                         if (messageBox.textContent === message) {
                             messageBox.classList.add('hidden');
                         }
                     }, 5000);
                }
            };
            
             const convertTo24Hour = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(' ')) return '00:00'; 
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');
                if (hours === '12') hours = '00';
                if (modifier.toUpperCase() === 'PM') hours = parseInt(hours, 10) + 12;
                if (modifier.toUpperCase() === 'PM' && time.split(':')[0] === '12') hours = 12;
                return `${String(hours).padStart(2, '0')}:${minutes}`;
            };
            
            const colorPalette = [
                "#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#42d4f4", "#f032e6",
                "#bfef45", "#fabed4", "#469990", "#dcbeff", "#9A6324", "#fffac8", "#800000", "#aaffc3",
                "#808000", "#ffd8b1", "#000075", "#a9a9a9", "#f44336", "#2196F3", "#4CAF50", "#FFC107",
                "#673AB7", "#795548", "#FF5722", "#607D8B", "#E91E63", "#009688", "#CDDC39", "#9C27B0",
                "#03A9F4", "#8BC34A", "#FF9800", "#3F51B5", "#00BCD4", "#FFEB3B", "#9E9E9E", "#C2185B",
                "#0277BD", "#558B2F", "#F57F17", "#1A237E", "#006064", "#E65100", "#880E4F", "#311B92"
            ];
            const getColorForItem = (item) => {
                let hash = 0;
                if (!item || item.length === 0) return colorPalette[0];
                for (let i = 0; i < item.length; i++) {
                    hash = item.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash % colorPalette.length);
                return colorPalette[index];
            };

            const normalizeTimeSlot = (timeValue) => {
                if (typeof timeValue === 'string' && timeSlots.includes(timeValue)) {
                    return timeValue;
                }
                if (typeof timeValue === 'string' && timeValue.includes('T')) {
                    try {
                        const dateObj = new Date(timeValue);
                        return dateObj.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true,
                            timeZone: 'Asia/Kuala_Lumpur'
                        });
                    } catch (e) {
                        return timeValue; 
                    }
                }
                return timeValue;
            };

            // --- Core Functions ---
            const manageBookingAccess = () => {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0=Ahad, 1=Isnin, ..., 6=Sabtu

                // Kitaran tempahan baharu bermula pada setiap hari Sabtu.
                // Tetingkap tempahan dibuka dari Sabtu (Minggu N) hingga Jumaat (Minggu N+1).
                // Minggu yang ditempah dalam kitaran ini ialah minggu yang bermula pada Isnin (Minggu N+1).
                
                // Langkah 1: Cari hari Sabtu yang memulakan kitaran tempahan semasa.
                const currentCycleStartDate = new Date(today);
                const daysSinceSaturday = (dayOfWeek - 6 + 7) % 7;
                currentCycleStartDate.setDate(today.getDate() - daysSinceSaturday);

                // Langkah 2: Tentukan minggu yang boleh ditempah. 
                // Ia adalah minggu yang bermula pada hari Isnin, 2 hari selepas tarikh mula kitaran (Sabtu).
                const targetMonday = new Date(currentCycleStartDate);
                targetMonday.setDate(currentCycleStartDate.getDate() + 2);
                
                const targetFriday = new Date(targetMonday);
                targetFriday.setDate(targetMonday.getDate() + 4);

                // Langkah 3: Elemen borang sentiasa diaktifkan kerana tetingkap tempahan sentiasa terbuka untuk satu minggu atau minggu yang lain.
                formElements.forEach(el => el.disabled = false);

                // Langkah 4: Tetapkan julat tarikh yang sah untuk medan input tarikh.
                dateInput.min = toYYYYMMDD(targetMonday);
                dateInput.max = toYYYYMMDD(targetFriday);
                
                // Langkah 5: Paparkan mesej bermaklumat tentang tetingkap tempahan semasa.
                showMessage(`Tempahan dibuka untuk minggu ${formatDateDisplay(targetMonday)} - ${formatDateDisplay(targetFriday)}. Tempahan ditutup pada hari Jumaat jam 11:59 PM.`, 'info');
            };

            const loadBookings = async () => {
                const loadingMessage = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-500">Memuatkan data...</td></tr>';
                bookingTableBody.innerHTML = loadingMessage;
                renderTimetableView([]);
                try {
                    const response = await fetch(SCRIPT_URL);
                    const result = await response.json();
                    if (result.success) {
                        allBookings = result.data;
                        renderBookings();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    console.error("Error loading bookings:", error);
                    bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuatkan data. Sila periksa sambungan internet anda.</td></tr>';
                }
            };
            
            const renderTimetableView = (weekBookings) => {
                const colorBy = 'teacher';
                const legendItems = new Set();

                document.querySelectorAll('.timetable-cell').forEach(cell => {
                    cell.style.backgroundColor = '';
                    cell.title = 'Slot kosong';
                });
                
                weekBookings.forEach(booking => {
                    const bookingDate = new Date(booking.date);
                    const dayName = daysOfWeek[bookingDate.getUTCDay()];
                    
                    const normalizedTime = normalizeTimeSlot(booking.timeSlot);
                    if (normalizedTime) {
                        const timeSlotId = normalizedTime.replace(/[:\s]/g, '');
                        if (dayName && timeSlotId) {
                            const cellId = `${dayName}-${timeSlotId}`;
                            const cell = document.getElementById(cellId);
                            if (cell) {
                                const itemToColor = booking[colorBy];
                                const color = getColorForItem(itemToColor);
                                cell.style.backgroundColor = color;
                                cell.title = `Guru: ${booking.teacher}\nKelas: ${booking.class}\nSubjek: ${booking.subject}\nMasa: ${normalizedTime}`;
                                legendItems.add(itemToColor);
                            }
                        }
                    }
                });

                colorLegend.innerHTML = '';
                if (legendItems.size === 0) {
                     if (weekBookings.length > 0) {
                        colorLegend.innerHTML = '<p class="text-slate-500">Tiada data tempahan untuk dipaparkan dalam jadual.</p>';
                    }
                } else {
                    Array.from(legendItems).sort().forEach(item => {
                        const color = getColorForItem(item);
                        const legendItem = document.createElement('div');
                        legendItem.className = 'flex items-center';
                        legendItem.innerHTML = `<span class="w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span><span>${item}</span>`;
                        colorLegend.appendChild(legendItem);
                    });
                }
            };

            const renderBookings = () => {
                const week = getWeekRange(currentDate);
                weekRangeDisplay.textContent = `${formatDateDisplay(week.start)} - ${formatDateDisplay(week.end)}`;
                const weekBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.date);
                    return bookingDate >= week.start && bookingDate <= week.end;
                });

                bookingTableBody.innerHTML = '';
                if (weekBookings.length === 0) {
                    bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-500">Tiada tempahan untuk minggu ini.</td></tr>';
                } else {
                     weekBookings.sort((a, b) => {
                        const dateA = new Date(a.date).getTime();
                        const dateB = new Date(b.date).getTime();
                        if (dateA !== dateB) return dateA - dateB;
                        const timeA = convertTo24Hour(normalizeTimeSlot(a.timeSlot));
                        const timeB = convertTo24Hour(normalizeTimeSlot(b.timeSlot));
                        return timeA.localeCompare(timeB);
                    });

                    weekBookings.forEach(booking => {
                        const row = document.createElement('tr');
                        const bookingDateObj = new Date(booking.date);
                        
                        const displayTime = normalizeTimeSlot(booking.timeSlot);

                        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${bookingDateObj.toLocaleString('ms-MY', { weekday: 'long', day: '2-digit', month: '2-digit'})}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${displayTime}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.teacher}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.class}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.subject}</td>`;
                        bookingTableBody.appendChild(row);
                    });
                }
                
                renderTimetableView(weekBookings);
            };

            // --- Event Listeners ---
            refreshBtn.addEventListener('click', loadBookings);
            
            prevWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 7);
                renderBookings();
            });

            nextWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 7);
                renderBookings();
            });

            dateInput.addEventListener('input', (e) => {
                const selectedDate = new Date(e.target.value);
                const day = selectedDate.getUTCDay();
                if (day === 6 || day === 0) {
                    showMessage('Tempahan hanya dibenarkan pada hari Isnin hingga Jumaat.', 'error');
                    e.target.value = '';
                }
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newBookingData = { id: Date.now(), teacher: teacherSelect.value, class: classSelect.value, subject: subjectSelect.value, date: dateInput.value, timeSlot: timeSlotSelect.value };
                const isBooked = allBookings.some(booking => {
                    const existingDateStr = toYYYYMMDD(new Date(booking.date));
                    const existingTimeSlot = normalizeTimeSlot(booking.timeSlot);
                    return existingDateStr === newBookingData.date && existingTimeSlot === newBookingData.timeSlot;
                });

                if (isBooked) {
                    showMessage('Slot masa ini telah ditempah. Sila pilih slot lain.', 'error');
                    return;
                }
                setLoadingState(true, submitButton, submitButtonText, 'Tempah Slot');
                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addBooking', booking: newBookingData }) });
                    const result = await response.json();
                    if(result.success) {
                        showMessage('Tempahan berjaya!', 'success');
                        bookingForm.reset();
                        await loadBookings();
                    } else { throw new Error(result.message); }
                } catch(error) {
                     console.error("Error adding booking:", error);
                     showMessage('Gagal untuk membuat tempahan.', 'error');
                } finally {
                    setLoadingState(false, submitButton, submitButtonText, 'Tempah Slot');
                    manageBookingAccess();
                }
            });

            // --- Initial Setup ---
            const initializeTimetableStructure = () => {
                timeSlots.forEach(time => {
                    const row = document.createElement('tr');
                    const timeCell = `<td class="p-2 text-sm font-semibold bg-slate-50">${time}</td>`;
                    let dayCells = '';
                    daysOfWeek.slice(1, 6).forEach(day => { // Isnin to Jumaat
                        const timeSlotId = time.replace(/[:\s]/g, '');
                        dayCells += `<td id="${day}-${timeSlotId}" class="timetable-cell border border-slate-200" title="Slot kosong"></td>`;
                    });
                    row.innerHTML = timeCell + dayCells;
                    timetableBody.appendChild(row);
                });
            };

            populateSelect(teacherSelect, teachers);
            populateSelect(classSelect, classes);
            populateSelect(subjectSelect, subjects);
            populateSelect(timeSlotSelect, timeSlots, false);
            
            initializeTimetableStructure();
            
            manageBookingAccess(); 
            loadBookings(); 
        });
    </script>
</body>
</html>





