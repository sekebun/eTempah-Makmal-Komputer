<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem eTempah Makmal Komputer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for disabled elements */
        button:disabled, input:disabled, select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <img src="https://i.postimg.cc/503jYPY1/LOGO-SEKOLAH-SKTK-removebg-preview.png" alt="Logo Sekolah" class="mx-auto h-24 w-auto mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-700">Sistem eTempah Makmal Komputer</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-6 border-b pb-4">Borang Tempahan</h2>
                <form id="bookingForm" class="space-y-4">
                    
                    <div>
                        <label for="teacher" class="block text-sm font-medium text-slate-700 mb-1">Nama Guru</label>
                        <select id="teacher" name="teacher" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                            <option value="" disabled selected>-- Sila Pilih Guru --</option>
                        </select>
                    </div>

                    <div>
                        <label for="class" class="block text-sm font-medium text-slate-700 mb-1">Nama Kelas</label>
                        <select id="class" name="class" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                             <option value="" disabled selected>-- Sila Pilih Kelas --</option>
                        </select>
                    </div>

                    <div>
                        <label for="subject" class="block text-sm font-medium text-slate-700 mb-1">Subjek</label>
                        <select id="subject" name="subject" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                            <option value="" disabled selected>-- Sila Pilih Subjek --</option>
                        </select>
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-slate-700 mb-1">Tarikh</label>
                        <input type="date" id="date" name="date" class="mt-1 block w-full pl-3 pr-4 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                    </div>

                    <div>
                        <label for="timeSlot" class="block text-sm font-medium text-slate-700 mb-1">Slot Masa</label>
                        <select id="timeSlot" name="timeSlot" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                             <option value="" disabled selected>-- Sila Pilih Masa --</option>
                        </select>
                    </div>

                    <div id="messageBox" class="hidden p-3 rounded-md text-sm transition-opacity duration-300"></div>

                    <button type="submit" id="submitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-300 flex items-center justify-center">
                        <span id="submitButtonText">Tempah Slot</span>
                    </button>

                </form>
            </div>

            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center border-b pb-4 mb-2">
                    <h2 class="text-2xl font-semibold">Senarai Tempahan Makmal</h2>
                    <button id="refreshBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-md transition-colors text-sm">
                        Refresh
                    </button>
                </div>
                
                <div class="flex justify-between items-center my-4 p-2 bg-slate-100 rounded-lg">
                    <button id="prevWeekBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                        &lt; Lepas
                    </button>
                    <h3 id="weekRangeDisplay" class="text-lg font-semibold text-center text-slate-700"></h3>
                    <button id="nextWeekBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                        Depan &gt;
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tarikh</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Masa</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Guru</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kelas</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Subjek</th>
                            </tr>
                        </thead>
                        <tbody id="bookingTableBody" class="bg-white divide-y divide-slate-200">
                             <tr>
                                <td colspan="5" class="px-6 py-10 text-center text-slate-500">Memuatkan data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxWneuWlrUkDGJBZXvSkjPfIuuBte6wV3XZDA1FOiyL1b1EbvqILENrOs_87NiebqK_/exec";

            // --- Data for dropdowns ---
            const teachers = ["AMIRUL FAHMI BIN YUSUP", "AQEELA BINTI ALIAH", "ELIANE BINTI AZMI", "EMYLIA FARHAN BINTI MOHAMAD YUSOF", "FALIZAH BINTI MOHAMAD ARSHAD", "FARIDAH BINTI HAMZAH", "HAYATI BINTI RAMLI", "IDAHTUL ARRSHYUL NA'AIEM BINTI A. RAHMAN", "KHAIRUL HAFFIZ BIN AZIZAN", "MAHANUM BINTI MOKHTAR", "MAZIAH BINTI MUHAMMAD", "MAZNAH BINTI KAMARUDDIN", "MOHAMED ZAMRI BIN SALLEH", "MOHD MUZAMER BIN ZAINODDIN", "MOHD ZAHARI BIN ISHAK", "NADHATUL AKMA BINTI ZAINAL", "NAIMAH BINTI MOHD NOH", "NOOR HAFIZAH BINTI OTHMAN", "NOORSUZANA BINTI NORDIN", "NOR AZIDAH BINTI MOHAMAD", "NOR EAZAH BINTI ITHNIN", "NOR MAIZANNI BINTI KHALIDI", "NORYANA BINTI ABDUL RAZAK", "NURUL ASHIKIN BINTI AMIRUDDIN", "NURUL SYAZWANI BINTI MD BASRI", "ROHAIDA BINTI MD ALI", "ROHAYA BINTI IBERAHIM", "ROSLAN BIN IBRAHIM", "ROZAINI BINTI TAJON AROS", "ROZIANA BINTI ARRIFFIN", "SITI MARHAMAH BINTI MUHAMAD", "SITI SANISAH BINTI HUSAIN", "SITI ZAHARAH BINTI ISHAK", "ZAITOON BINTI AHMAD", "ZAURAIDAH BINTI KAMARUDIN"];
            const classes = ["1 Al Ikhlas", "1 Al Falaq", "1 An Nas", "2 Al Ikhlas", "2 Al Falaq", "3 Al Ikhlas", "3 Al Falaq", "3 An Nas", "4 Al Ikhlas", "4 Al Falaq", "5 Al Ikhlas", "5 Al Falaq", "5 An Nas", "6 Al Ikhlas", "6 Al Falaq"];
            const subjects = ["BM", "BI", "MT", "SN", "PJ", "PK", "RBT", "SJ", "MZ", "PS", "PI", "ULM", "JW", "TS", "BA"];
            const timeSlots = ["07:40 AM", "08:10 AM", "08:40 AM", "09:10 AM", "09:40 AM", "10:10 AM", "10:30 AM", "11:00 AM", "11:30 AM", "12:00 PM", "12:30 PM", "01:00 PM"];

            // --- Get elements ---
            const bookingForm = document.getElementById('bookingForm');
            const teacherSelect = document.getElementById('teacher');
            const classSelect = document.getElementById('class');
            const subjectSelect = document.getElementById('subject');
            const dateInput = document.getElementById('date');
            const timeSlotSelect = document.getElementById('timeSlot');
            const bookingTableBody = document.getElementById('bookingTableBody');
            const messageBox = document.getElementById('messageBox');
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const weekRangeDisplay = document.getElementById('weekRangeDisplay');
            const submitButton = document.getElementById('submitButton');
            const submitButtonText = document.getElementById('submitButtonText');
            const refreshBtn = document.getElementById('refreshBtn');

            // --- State Management ---
            let allBookings = [];
            let currentDate = new Date();

            // --- Helper Functions ---
            const setLoadingState = (isLoading, element, textElement = null, originalText = '') => {
                if (isLoading) {
                    element.disabled = true;
                    if (textElement) textElement.textContent = '';
                    const loader = document.createElement('span');
                    loader.className = 'loader';
                    element.prepend(loader);
                } else {
                    element.disabled = false;
                    const loader = element.querySelector('.loader');
                    if (loader) loader.remove();
                    if (textElement) textElement.textContent = originalText;
                }
            };
            
            const getWeekRange = (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diffToMonday = d.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(d.setDate(diffToMonday));
                monday.setHours(0, 0, 0, 0);
                const friday = new Date(new Date(monday).setDate(monday.getDate() + 4));
                friday.setHours(23, 59, 59, 999);
                return { start: monday, end: friday };
            };

            const formatDateDisplay = (date) => date.toLocaleString('ms-MY', { day: '2-digit', month: 'short' });

            const populateSelect = (selectElement, options) => {
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
            };

            const showMessage = (message, isError = false) => {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-800' : 'text-green-800');
                setTimeout(() => messageBox.classList.add('hidden'), 4000);
            };
            
             const convertTo24Hour = (timeStr) => {
                // Add a defensive check to handle undefined or malformed time strings
                if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(' ')) {
                    console.warn(`Invalid timeSlot format received: ${timeStr}. Using default for sorting.`);
                    return '00:00'; // Return a default value to prevent sort from breaking
                }
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');
                if (hours === '12') hours = '00';
                if (modifier.toUpperCase() === 'PM') hours = parseInt(hours, 10) + 12;
                if (modifier.toUpperCase() === 'PM' && time.split(':')[0] === '12') hours = 12;
                return `${String(hours).padStart(2, '0')}:${minutes}`;
            };
            
            // --- Core Functions ---
            const loadBookings = async () => {
                bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-500">Memuatkan data...</td></tr>';
                try {
                    const response = await fetch(SCRIPT_URL);
                    const result = await response.json();
                    if (result.success) {
                        allBookings = result.data;
                        renderBookings();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error("Error loading bookings:", error);
                    bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Gagal memuatkan data. Sila periksa tetapan Google Sheet dan skrip anda.</td></tr>';
                }
            };
            
            const renderBookings = () => {
                const week = getWeekRange(currentDate);
                weekRangeDisplay.textContent = `${formatDateDisplay(week.start)} - ${formatDateDisplay(week.end)}`;

                const weekBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.date);
                    bookingDate.setHours(0, 0, 0, 0); // Normalize to compare dates only
                    return bookingDate >= week.start && bookingDate <= week.end;
                });

                bookingTableBody.innerHTML = '';
                if (weekBookings.length === 0) {
                    bookingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-slate-500">Tiada tempahan untuk minggu ini.</td></tr>';
                    return;
                }

                // Sort bookings: primary sort by date, secondary sort by time
                weekBookings.sort((a, b) => {
                    const dateA = new Date(a.date).getTime();
                    const dateB = new Date(b.date).getTime();
                    if (dateA !== dateB) {
                        return dateA - dateB;
                    }
                    // If dates are the same, sort by time
                    const timeA = convertTo24Hour(a.timeSlot);
                    const timeB = convertTo24Hour(b.timeSlot);
                    return timeA.localeCompare(timeB);
                });

                weekBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    const bookingDateObj = new Date(booking.date);
                    let displayTime = booking.timeSlot;

                    // This block handles the incorrect time format from Google Sheets
                    if (typeof booking.timeSlot === 'string' && (booking.timeSlot.includes('T') || booking.timeSlot.includes('Z'))) {
                        try {
                            const timeAsDate = new Date(booking.timeSlot);
                            // Google Sheets sometimes interprets time as a date from 1899
                            if (timeAsDate.getFullYear() === 1899) {
                                displayTime = timeAsDate.toLocaleTimeString('en-US', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: true
                                });
                            }
                        } catch (e) { /* Fallback to original string if parsing fails */ }
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${bookingDateObj.toLocaleString('ms-MY', { weekday: 'long', day: '2-digit', month: '2-digit'})}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${displayTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.teacher}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.class}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.subject}</td>
                    `;
                    bookingTableBody.appendChild(row);
                });
            };

            // --- Event Listeners ---
            refreshBtn.addEventListener('click', loadBookings);

            prevWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 7);
                renderBookings();
            });

            nextWeekBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 7);
                renderBookings();
            });
            
            dateInput.addEventListener('input', (e) => {
                const selectedDate = new Date(e.target.value);
                const day = selectedDate.getUTCDay(); // Use getUTCDay() to avoid timezone issues
                if (day === 6 || day === 0) {
                    showMessage('Tempahan hanya dibenarkan pada hari Isnin hingga Jumaat.', true);
                    e.target.value = '';
                }
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newBookingData = {
                    id: Date.now(),
                    teacher: teacherSelect.value,
                    class: classSelect.value,
                    subject: subjectSelect.value,
                    date: dateInput.value,
                    timeSlot: timeSlotSelect.value,
                };
                
                // Client-side check to prevent double booking with improved date and time normalization.
                const isBooked = allBookings.some(booking => {
                    // Normalize date from sheet (which can be a full ISO string) to YYYY-MM-DD format
                    const existingDate = new Date(booking.date);
                    const existingDateStr = `${existingDate.getFullYear()}-${String(existingDate.getMonth() + 1).padStart(2, '0')}-${String(existingDate.getDate()).padStart(2, '0')}`;
                    
                    // Normalize time from sheet (which can be a date object string) to match dropdown format
                    let existingTimeSlot = booking.timeSlot;
                    if (typeof booking.timeSlot === 'string' && booking.timeSlot.includes('T') && booking.timeSlot.includes('Z')) {
                        try {
                            const timeAsDate = new Date(booking.timeSlot);
                            if (timeAsDate.getFullYear() === 1899) {
                                existingTimeSlot = timeAsDate.toLocaleTimeString('en-US', {
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: true
                                });
                            }
                        } catch(e) { /* If parsing fails, it won't match anyway */ }
                    }

                    // Compare normalized date and time with the new booking data
                    return existingDateStr === newBookingData.date && existingTimeSlot === newBookingData.timeSlot;
                });

                if (isBooked) {
                    showMessage('Slot masa ini telah ditempah. Sila pilih slot lain.', true);
                    return;
                }
                
                setLoadingState(true, submitButton, submitButtonText, 'Tempah Slot');

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'addBooking', booking: newBookingData }),
                    });
                    const result = await response.json();

                    if(result.success) {
                        showMessage('Tempahan berjaya!', false);
                        bookingForm.reset();
                        dateInput.min = new Date().toISOString().split("T")[0];
                        await loadBookings(); // Reload data from sheet
                    } else {
                        throw new Error(result.message);
                    }
                } catch(error) {
                     console.error("Error adding booking:", error);
                     showMessage('Gagal untuk membuat tempahan.', true);
                } finally {
                    setLoadingState(false, submitButton, submitButtonText, 'Tempah Slot');
                }
            });

            // --- Initial Setup ---
            populateSelect(teacherSelect, teachers);
            populateSelect(classSelect, classes);
            populateSelect(subjectSelect, subjects);
            populateSelect(timeSlotSelect, timeSlots);
            dateInput.min = new Date().toISOString().split("T")[0];
            loadBookings(); // Load initial data from Google Sheet
        });
    </script>
</body>
</html>

